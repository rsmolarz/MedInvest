{% extends "base.html" %}

{% block title %}User Roles & Permissions - Admin - MedInvest{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-user-shield me-2 text-primary"></i>User Roles & Permissions</h2>
            <p class="text-muted mb-0">Manage access levels and permissions across the platform</p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createRoleModal">
            <i class="fas fa-plus me-2"></i>Create Role
        </button>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Roles</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Role</th>
                                    <th>Users</th>
                                    <th>Permissions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-danger me-2">Admin</span>
                                            <small class="text-muted">Full system access</small>
                                        </div>
                                    </td>
                                    <td>{{ admin_count or 0 }}</td>
                                    <td>
                                        <span class="badge bg-secondary me-1">All</span>
                                    </td>
                                    <td>
                                        <span class="text-muted small">System role</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-warning text-dark me-2">Moderator</span>
                                            <small class="text-muted">Content moderation</small>
                                        </div>
                                    </td>
                                    <td>{{ moderator_count or 0 }}</td>
                                    <td>
                                        <span class="badge bg-secondary me-1">moderate</span>
                                        <span class="badge bg-secondary me-1">view_reports</span>
                                        <span class="badge bg-secondary">ban_users</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="editRole('moderator')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-info me-2">Verified</span>
                                            <small class="text-muted">Verified medical professional</small>
                                        </div>
                                    </td>
                                    <td>{{ verified_count or 0 }}</td>
                                    <td>
                                        <span class="badge bg-secondary me-1">post</span>
                                        <span class="badge bg-secondary me-1">comment</span>
                                        <span class="badge bg-secondary">view_deals</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="editRole('verified')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-secondary me-2">Member</span>
                                            <small class="text-muted">Standard user</small>
                                        </div>
                                    </td>
                                    <td>{{ member_count or 0 }}</td>
                                    <td>
                                        <span class="badge bg-secondary me-1">post</span>
                                        <span class="badge bg-secondary">comment</span>
                                    </td>
                                    <td>
                                        <span class="text-muted small">Default role</span>
                                    </td>
                                </tr>
                                
                                {% for role in custom_roles %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="badge" style="background-color: {{ role.color or '#6c757d' }}">{{ role.name }}</span>
                                            <small class="text-muted ms-2">{{ role.description }}</small>
                                        </div>
                                    </td>
                                    <td>{{ role.user_count or 0 }}</td>
                                    <td>
                                        {% for perm in role.permissions[:3] %}
                                        <span class="badge bg-secondary me-1">{{ perm }}</span>
                                        {% endfor %}
                                        {% if role.permissions|length > 3 %}
                                        <span class="badge bg-light text-dark">+{{ role.permissions|length - 3 }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary" onclick="editRole('{{ role.id }}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteRole('{{ role.id }}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Recent Role Changes</h5>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for change in role_changes %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ change.user.username }}</strong>
                                <span class="text-muted mx-2">â†’</span>
                                <span class="badge bg-{{ change.role_color or 'secondary' }}">{{ change.new_role }}</span>
                            </div>
                            <small class="text-muted">{{ change.created_at.strftime('%b %d, %H:%M') if change.created_at else 'N/A' }}</small>
                        </li>
                        {% else %}
                        <li class="list-group-item text-center text-muted py-3">No recent changes</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Available Permissions</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-muted small text-uppercase">Content</h6>
                        <div class="d-flex flex-wrap gap-1">
                            <span class="badge bg-light text-dark">post</span>
                            <span class="badge bg-light text-dark">comment</span>
                            <span class="badge bg-light text-dark">like</span>
                            <span class="badge bg-light text-dark">share</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted small text-uppercase">Deals & Courses</h6>
                        <div class="d-flex flex-wrap gap-1">
                            <span class="badge bg-light text-dark">view_deals</span>
                            <span class="badge bg-light text-dark">create_deals</span>
                            <span class="badge bg-light text-dark">enroll_courses</span>
                            <span class="badge bg-light text-dark">create_courses</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted small text-uppercase">Moderation</h6>
                        <div class="d-flex flex-wrap gap-1">
                            <span class="badge bg-light text-dark">moderate</span>
                            <span class="badge bg-light text-dark">view_reports</span>
                            <span class="badge bg-light text-dark">ban_users</span>
                            <span class="badge bg-light text-dark">delete_content</span>
                        </div>
                    </div>
                    <div>
                        <h6 class="text-muted small text-uppercase">Admin</h6>
                        <div class="d-flex flex-wrap gap-1">
                            <span class="badge bg-light text-dark">manage_users</span>
                            <span class="badge bg-light text-dark">manage_roles</span>
                            <span class="badge bg-light text-dark">view_analytics</span>
                            <span class="badge bg-light text-dark">manage_settings</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Quick Assign</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.assign_role') if url_for else '/admin/roles/assign' }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label for="userId" class="form-label">User</label>
                            <input type="text" class="form-control" id="userId" name="username" 
                                   placeholder="Enter username">
                        </div>
                        <div class="mb-3">
                            <label for="roleId" class="form-label">Role</label>
                            <select class="form-select" id="roleId" name="role">
                                <option value="member">Member</option>
                                <option value="verified">Verified</option>
                                <option value="moderator">Moderator</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Assign Role</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createRoleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin.create_role') if url_for else '/admin/roles' }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Create Custom Role</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="roleName" class="form-label">Role Name</label>
                        <input type="text" class="form-control" id="roleName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="roleDescription" class="form-label">Description</label>
                        <input type="text" class="form-control" id="roleDescription" name="description">
                    </div>
                    <div class="mb-3">
                        <label for="roleColor" class="form-label">Badge Color</label>
                        <input type="color" class="form-control form-control-color" id="roleColor" name="color" value="#6366f1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Permissions</label>
                        <div class="row">
                            {% set permissions = ['post', 'comment', 'like', 'view_deals', 'enroll_courses', 'moderate', 'view_reports', 'ban_users'] %}
                            {% for perm in permissions %}
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="{{ perm }}" id="perm_{{ loop.index }}">
                                    <label class="form-check-label" for="perm_{{ loop.index }}">{{ perm }}</label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Role</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function editRole(roleId) {
    alert('Edit role: ' + roleId);
}

function deleteRole(roleId) {
    if (confirm('Delete this role? Users with this role will be assigned the default Member role.')) {
        fetch(`/admin/roles/${roleId}`, { method: 'DELETE' })
            .then(() => location.reload());
    }
}
</script>
{% endblock %}
